<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Content + Staticman Comments</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f7fafc; color:#0f172a; padding:20px; max-width:960px; margin:0 auto;}
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;}
    .card { background:white; border-radius:8px; box-shadow:0 6px 20px rgba(2,6,23,0.08); padding:18px; margin-bottom:18px;}
    .comments { margin-top:14px; border-top:1px dashed #e6edf3; padding-top:12px;}
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input[type="text"], textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #dbe7f0; }
    button { margin-top:8px; padding:8px 12px; border-radius:8px; border:none; background:#0ea5e9; color:white; cursor:pointer;}
    .comment-list { margin-top:12px; background:#fbfdff; padding:8px; border-radius:6px; }
    .comment { padding:6px 8px; border-bottom:1px solid #edf6fb; }
    .meta { font-size:12px; color:#64748b; }
  </style>
</head>
<body>
  <header>
    <h1>Auto Content Viewer</h1>
    <a href="https://github.com/yan-shun-180" target="_blank" rel="noopener">View GitHub ↗</a>
  </header>

  <main id="contentRoot">
    <p>Loading content…</p>
  </main>

  <script>
  // CONFIG
  const STATICMAN_API = "https://staticman3.herokuapp.com/v3/entry";
  const GITHUB_USER = "yan-shun-180";
  const GITHUB_REPO = "welcoming_users_page";
  const GITHUB_BRANCH = "main";

  // Helpers
  function slugFromFilename(filename){
    const n = filename.replace(/\\/g,'/').split('/').pop();
    return n.replace(/\.[^/.]+$/, "");
  }

  async function loadDataTxt(){
    const r = await fetch('data.txt');
    if (!r.ok) throw new Error('Failed to load data.txt');
    const txt = await r.text();
    return txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  }

  async function fetchFileContent(path){
    const r = await fetch(path, {cache:"no-store"});
    if (!r.ok) throw new Error('Cannot load file: ' + path);
    return await r.text();
  }

  // Create Staticman comment form
  function createCommentForm(slug){
    const action = `${STATICMAN_API}/${encodeURIComponent(GITHUB_USER)}/${encodeURIComponent(GITHUB_REPO)}/${encodeURIComponent(GITHUB_BRANCH)}/comments`;
    return `
      <form method="POST" action="${action}">
        <input type="hidden" name="options[slug]" value="${slug}">
        <label>Name</label>
        <input name="fields[name]" type="text" placeholder="Your name" required>
        <label>Comment</label>
        <textarea name="fields[message]" rows="3" placeholder="Write a comment..." required></textarea>
        <button type="submit">Post Comment</button>
      </form>
    `;
  }

  // Load comments
  async function loadComments(slug, target){
    const url = `_data/comments/${slug}/comments.json`;
    try {
      const r = await fetch(url);
      if (!r.ok) {
        target.innerHTML = '<div class="meta">Comments will appear after approval or rebuild.</div>';
        return;
      }
      const comments = await r.json();
      if (!comments.length) {
        target.innerHTML = '<div class="meta">No comments yet — be first!</div>';
        return;
      }
      target.innerHTML = comments.map(c => `
        <div class="comment">
          <div>${c.message}</div>
          <div class="meta">— ${c.name} • ${c.date}</div>
        </div>
      `).join('');
    } catch {
      target.innerHTML = '<div class="meta">Comments unavailable.</div>';
    }
  }

  // Non-blocking content loading
  async function loadContent(){
    const root = document.getElementById("contentRoot");
    root.innerHTML = '';
    const files = await loadDataTxt();

    // Load all files in parallel
    const promises = files.map(async file => {
      try {
        const html = await fetchFileContent(file);
        const slug = slugFromFilename(file);

        const div = document.createElement('div');
        div.className = "card";
        div.innerHTML = `
          <div class="content-block">${html}</div>
          <div class="comments">
            <h3>Comments</h3>
            ${createCommentForm(slug)}
            <div id="comment-list-${slug}" class="comment-list">Loading comments…</div>
          </div>
        `;
        root.appendChild(div);

        const listDiv = div.querySelector(`#comment-list-${slug}`);
        loadComments(slug, listDiv);
      } catch(err) {
        const errorDiv = document.createElement('div');
        errorDiv.className = "card";
        errorDiv.innerHTML = `<p>Error loading ${file}: ${err.message}</p>`;
        root.appendChild(errorDiv);
      }
    });

    await Promise.all(promises); // ensures all are loaded
  }

  loadContent();
  </script>
</body>
</html>
